name: CI
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  merge_group:
    types:
      - checks_requested

permissions:
  contents: write
  pull-requests: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run unit tests
        run: yarn test --maxWorkers=2 --coverage --passWithNoTests

  build-library:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build package
        run: yarn prepare

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build-library]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup
        uses: ./.github/actions/setup

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch latest changes and rebase
        run: |
          git fetch origin main --tags --force
          git checkout main
          git pull --rebase origin main || echo "No changes to pull"
          git fetch origin --tags --force

      - name: Setup npm for publishing
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          registry-url: 'https://registry.npmjs.org'
          # NPM_TOKEN must be a granular access token (not classic token)
          # Create one at: https://www.npmjs.com/settings/YOUR_USERNAME/access-tokens
          # Required permissions: Read and Write packages
          # CRITICAL: Must enable "Bypass 2FA" option for CI/CD automation
          # Token type: Granular Access Token (Automation)
          # Note: Classic tokens are no longer supported as of Dec 2025
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify npm authentication
        run: |
          npm whoami || (echo "Error: npm authentication failed" && exit 1)
          echo "âœ“ npm authenticated successfully"

      - name: Build package
        run: yarn prepare

      - name: Create Release and Publish
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version in package.json: ${CURRENT_VERSION}"

          # Check if version already exists in npm
          if npm view react-native-unified-player@${CURRENT_VERSION} version > /dev/null 2>&1; then
            echo "Version ${CURRENT_VERSION} already published on npm"

            # Get latest version from npm and increment patch
            LATEST_VERSION=$(npm view react-native-unified-player version 2>/dev/null || echo "0.0.0")
            echo "Latest npm version: ${LATEST_VERSION}"

            # Increment patch version
            NEW_VERSION=$(node -p "const v = '${LATEST_VERSION}'.split('.'); v[2] = parseInt(v[2]) + 1; v.join('.')")
            echo "New version: ${NEW_VERSION}"

            # Update package.json with new version
            npm version ${NEW_VERSION} --no-git-tag-version

            # Run release with the new version (no auto-increment)
            yarn run release --ci --no-increment
          else
            # Version doesn't exist, publish as-is (no auto-increment)
            yarn run release --ci --no-increment
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # NPM_TOKEN: Granular access token with publish permissions
          # Must have "Read and Write packages" permission
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}