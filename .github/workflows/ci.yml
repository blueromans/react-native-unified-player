name: CI
on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  merge_group:
    types:
      - checks_requested

permissions:
  contents: write
  pull-requests: read

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Lint files
        run: yarn lint

      - name: Typecheck files
        run: yarn typecheck

  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Run unit tests
        run: yarn test --maxWorkers=2 --coverage

  build-library:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup
        uses: ./.github/actions/setup

      - name: Build package
        run: yarn prepare

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [build-library]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup
        uses: ./.github/actions/setup

          - name: Configure Git
            run: |
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

          - name: Fetch latest changes
            run: |
              git fetch origin main --tags
              git checkout main
              git pull --rebase origin main || true

          - name: Setup npm for publishing
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          registry-url: 'https://registry.npmjs.org'
          # NPM_TOKEN must be a granular access token (not classic token)
          # Create one at: https://www.npmjs.com/settings/YOUR_USERNAME/access-tokens
          # Required permissions: Read and Write packages
          # CRITICAL: Must enable "Bypass 2FA" option for CI/CD automation
          # Token type: Granular Access Token (Automation)
          # Note: Classic tokens are no longer supported as of Dec 2025
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify npm authentication
        run: |
          npm whoami || (echo "Error: npm authentication failed" && exit 1)
          echo "âœ“ npm authenticated successfully"

      - name: Build package
        run: yarn prepare

      - name: Create Release and Publish
        run: yarn run release --ci
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # NPM_TOKEN: Granular access token with publish permissions
          # Must have "Read and Write packages" permission
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}